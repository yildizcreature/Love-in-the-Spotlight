extends Node2D


const in_edit_mode: bool = false
var current_level_name = "RHYTHM_HELL"

var fk_fall_time: float = 2.8
var fk_output_arr = [[], [], [], []]

var level_info = {
	"RHYTHM_HELL" = {
		"fk_times": "[[3.30099792480469, 5.17823143005371, 8.73004550933838, 12.1538545608521, 15.4603626251221, 19.9614517211914, 22.3186618804932, 27.1397277832031, 28.7609741210937, 30.2968933105469, 35.8859397888184, 41.3789779663086, 42.5095932006836, 44.1948310852051, 47.6186401367188, 49.9225151062012, 53.3570053100586, 57.2074615478516, 58.0074150085449, 61.0899307250977, 65.1110412597656, 66.1669876098633, 66.8709518432617, 68.1935607910156, 69.238818359375, 70.8387557983398, 71.926692199707, 72.3533355712891, 75.29716796875, 75.4358245849609, 78.4650146484375, 78.6356689453125, 78.8809768676758, 83.1900894165039, 84.896662902832, 85.6238357543945, 86.5925628662109, 88.7257797241211, 90.8483459472656, 91.3709747314453, 94.0055114746094, 94.9547836303711, 97.2800018310547, 100.330500793457, 101.055804443359, 102.293063354492, 103.658320617676, 104.831607055664, 106.29285736084, 107.306147766113, 108.07410736084, 108.810069274902, 109.69535369873, 110.399295043945, 111.135256958008, 111.903216552734, 112.671176147461, 113.417826843262, 119.529475402832, 120.39344329834, 121.18274230957, 121.929362487793, 123.134623718262, 123.614604187012, 124.105235290527, 124.574557495117, 127.859698486328, 132.318133544922, 132.990115356445, 133.619403076172, 135.251315307617, 136.627261352539, 138.696459960937, 140.200381469727, 141.149676513672, 141.309664916992, 141.448321533203, 141.576327514648, 141.704302978516, 142.0349609375, 142.333605957031, 144.285510253906, 145.106799316406, 145.917422485352, 147.112017822266, 147.858645629883, 149.458575439453, 150.333178710937, 152.253085327148, 153.063693237305, 155.068927001953, 156.199542236328, 156.967501831055, 158.89807434082, 159.250048828125, 161.777911376953, 162.161883544922, 162.556536865234, 165.329730224609, 165.703036499023, 166.087008666992, 166.918978881836, 167.708255004883, 168.61487121582, 170.364123535156, 173.243975830078, 174.011920166016, 179.579638671875, 180.454241943359, 181.350207519531, 183.387438964844, 185.509982299805, 185.957965087891, 187.237887573242, 187.707186889648, 189.019137573242, 189.435107421875, 190.811038208008, 191.163012695312, 192.57092590332, 192.912249755859, 195.290789794922, 195.69609375, 196.442736816406, 197.530673217773, 199.354586791992, 200.655856323242, 201.594470214844, 203.621020507812, 204.751635742187], [6.41551036834717, 9.94598598480225, 14.4790699005127, 17.1562587738037, 20.932063293457, 23.1826068878174, 30.9475280761719, 37.9124938964844, 45.7200691223145, 46.3387062072754, 48.9199096679688, 56.7595016479492, 60.3326293945313, 63.4791366577148, 64.2470962524414, 67.5749237060547, 73.2066223144531, 82.4327880859375, 83.3820831298828, 84.6406814575195, 87.4885284423828, 90.1443740844727, 93.5895263671875, 94.1761657714844, 96.9173461914063, 101.37578125, 104.042315673828, 117.054942321777, 117.502925109863, 117.950907897949, 118.356211853027, 118.825534057617, 127.422396850586, 131.966174316406, 132.648791503906, 134.046054077148, 136.051272583008, 136.829913330078, 138.451159667969, 139.133792114258, 146.14140625, 148.615939331055, 149.757205200195, 151.8904296875, 153.639682006836, 157.820788574219, 160.156665039062, 162.929843139648, 163.356478881836, 163.740481567383, 183.024783325195, 183.707415771484, 193.317568969727, 194.064196777344, 198.45862121582, 199.75989074707, 200.92248840332, 202.277102661133, 202.959735107422], [5.86086196899414, 12.8044893264771, 16.0683223724365, 20.5374156951904, 32.4194557189941, 32.8780967712402, 33.3367340087891, 33.8380500793457, 37.6885025024414, 45.112109375, 45.9440605163574, 48.0772773742676, 55.9808609008789, 60.6846267700195, 63.1164886474609, 63.8950988769531, 64.7697250366211, 67.3082534790039, 72.8866455078125, 76.2677795410156, 80.5982315063477, 85.9632675170898, 88.2671463012695, 90.4963714599609, 91.8189575195313, 93.248210144043, 94.3361694335938, 96.4693862915039, 97.802653503418, 98.2612945556641, 98.655940246582, 99.0505706787109, 99.4345581054688, 105.162242126465, 122.675982666016, 127.017092895508, 135.603305053711, 137.181887817383, 138.077853393555, 146.365390014648, 148.221286010742, 150.642489624023, 151.485125732422, 157.415469360352, 159.847354125977, 175.921160888672, 176.614443969727, 177.371752929687, 178.15036315918, 193.69089050293, 198.095980834961, 201.978442382812, 202.629077148437], [4.26095218658447, 7.77009029388428, 10.7565986633301, 11.0232650756836, 11.2045804977417, 11.5565530776978, 13.775101852417, 15.001700592041, 19.4387981414795, 21.4973690032959, 26.2651016235352, 27.9183666229248, 29.5289337158203, 31.8008148193359, 36.909888458252, 38.9684364318848, 40.3656913757324, 42.1895935058594, 43.81083984375, 46.5626976013184, 49.1758949279785, 51.9277565002441, 55.1489097595215, 57.6021072387695, 59.9379837036133, 61.4099075317383, 61.8472091674805, 62.2845336914063, 62.6578475952148, 65.5270263671875, 66.518977355957, 67.9162322998047, 68.4921981811523, 69.718798828125, 71.5884582519531, 72.097346496582, 74.0065795898438, 74.7212020874023, 75.8304779052734, 77.2063934326172, 77.5797302246094, 80.3635589599609, 80.7475540161133, 81.9954864501953, 82.7847854614258, 84.1607009887695, 85.1633102416992, 86.3579132080078, 87.7658493041992, 89.7710678100586, 91.0936767578125, 92.7895690917969, 94.549479675293, 96.672038269043, 99.7972137451172, 100.714488220215, 101.738436889648, 103.18902130127, 104.51160736084, 105.535556030273, 106.922152709961, 107.636782836914, 108.41541595459, 109.290019226074, 110.015330505371, 110.751292419434, 111.51925201416, 112.255213928223, 113.055171203613, 113.972445678711, 114.377757263184, 114.815081787109, 115.220385742188, 115.700366210938, 119.977458190918, 120.777415466309, 121.545375061035, 122.259997558594, 125.822497558594, 126.387805175781, 128.371676635742, 128.617007446289, 129.011660766602, 129.448962402344, 129.843600463867, 130.21692199707, 133.235415649414, 134.739337158203, 136.253924560547, 137.661853027344, 139.613757324219, 140.595034790039, 142.824237060547, 144.680163574219, 145.490771484375, 146.674716186523, 147.367999267578, 149.063922119141, 150.06653137207, 151.111819458008, 152.637057495117, 154.076983642578, 154.322314453125, 154.631625366211, 155.516909790039, 155.751559448242, 155.900881958008, 156.551516723633, 158.300769042969, 160.551318359375, 161.009951782227, 161.404605102539, 164.135119628906, 164.572421264648, 164.935076904297, 166.502993774414, 167.29228515625, 168.070910644531, 172.817324829102, 173.585284423828, 179.11032409668, 179.910266113281, 182.299472045898, 184.475375366211, 186.437930297852, 186.82190246582, 188.165850830078, 188.571154785156, 189.883090209961, 190.352374267578, 191.717639160156, 192.112292480469, 194.490832519531, 194.917483520508, 196.069415283203, 197.061358642578, 198.949267578125, 200.207873535156, 201.125140380859, 203.375689697266, 203.972994995117]]",
		"music": load("res://escenas/minijuego/musica/What Is This Feeling.wav")
	}
}

# Called when the node enters the scene tree for the first time.
func _ready() :
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_left"
				1:
					button_name = "button_down"
				2:
					button_name = "button_up"
				3:
					button_name = "button_right"
			
			for delay in key: 
				SpawnFallingKey(button_name, delay)
				
			counter += 1
			
func KeyListenerPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished() -> void:
	print(fk_output_arr)
